-# encoding: UTF-8
-#
-# Copyright Alexander E. Fischer <aef@raxys.net>, 2011
-#
-# This file is part of Lilith.
-#
-# Lilith is free software: you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or
-# (at your option) any later version.
-#
-# Lilith is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-#
-# You should have received a copy of the GNU General Public License
-# along with Lilith.  If not, see <http://www.gnu.org/licenses/>.
- set_body_id :schedules
%h2= t('schedules.schedule_composition')

%form{:action => semester_schedules_path(@semester.token)}
  %h3= t('schedules.navigation')

  .controls
    %p
      %label{:for => 'schedule_id'}= t('schedules.actuality') + ': '
      %select{:id => 'schedule_id', :name => 'schedule_id'}
        %option{:value => 'latest', :selected => 'selected'}= t('schedules.latest')
        = options_for_select @schedules.map{|schedule| [l(schedule.created_at), schedule.id]}
    %p
      %label{:for => 'format'}= t('schedules.format') + ': '
      %select{:id => 'format', :name => 'f'}
        %option{:value => 'ics'} iCalendar
        %option{:value => 'xml'} XML
    %p
      %label{:for => 'disposition_inline'}= t('schedules.inline') + ':'
      %input{:id => 'disposition_inline',     :name => 'd', :type => 'radio', :value => 'inline', :checked => 'checked'}
      %label{:for => 'disposition_attachment'}= t('schedules.attachment') + ':'
      %input{:id => 'disposition_attachment', :name => 'd', :type => 'radio', :value => 'attachment'}
    = submit_tag t('schedules.generate'), :name => nil

  -# Generate navigation index
  .navigation
    %table
      %tbody
        - @study_units.group_by(&:program).each do |program, study_units|
          %tr
            %td.program= program
            %td.units
              - study_units.each do |study_unit|
                %a{:href => "##{URI.escape(study_unit.name.gsub(/ /, '+'))}"}= study_unit.position

  - content_for(:filter) do # Inserted through JavaScript
    .filters
      %label{:for => 'course_filter'}= t('schedules.filter') + ':'
      .value
        %img.spinner{:src => '/images/spinner.gif', :alt => 'Loading...'}
        %input#course_filter{:type => 'text'}
        %img#course_filter_clear{:src => '/images/icons/cross.png', :alt => 'Clear'}

  %p
    %noscript
      = t('global.java_script_features')

  -# Generate sections
  .study_units
    - @study_units.each do |study_unit|
      = render :partial => 'study_unit', :locals => {:study_unit => study_unit}

:javascript
  // Add course filter bar
  $('#schedules .navigation').append("#{escape_javascript yield(:filter)}");

  var course_filter_timer;
  var course_filter_value = '';

  $(function() {
    // Course selection toggle
    $('#schedules .groups label').click(function() {
      var label = $(this);
      var check_box = label.children('input[type=checkbox]');

      if (check_box.is(':checked')) {
        label.addClass('selected');
      } else {
        label.removeClass('selected');
      }
    });

    // Hide all courses which do not match the given regular expression
    // If all courses are hidden in a study unit, the whole unit becomes hidden
    var course_filter_action = function() {

      var pattern = new RegExp($('#course_filter').val(), 'i');

      $('#schedules .study_unit').each(function() {
        var shown_count = 0;

        $(this).find('.courses > li').each(function() {
          if ($(this).find('h4').text().match(pattern)) {
            $(this).show();
            shown_count += 1;
          } else {
            $(this).hide();
          }
        });

        if (shown_count == 0) {
          $(this).hide();
        } else {
          $(this).show();
        }
      });

      course_filter_value = $('#course_filter').val();

      if ($('#course_filter').val() != '') {
        $('#schedules #course_filter_clear').css('visibility', 'visible');
      } else {
        $('#schedules #course_filter_clear').css('visibility', 'hidden');
      }

      $('#schedules .spinner').css('visibility', 'hidden');
    };

    // Amount of milliseconds for the finish-typing-timeout
    var course_filter_timeout = 500;

    // When a key is released, a timeout for filtering is activated
    $('#schedules #course_filter').keyup(function() {
      if (course_filter_value != $('#course_filter').val()) {
        course_filter_timer = setTimeout(course_filter_action, course_filter_timeout);
        $('#schedules .spinner').css('visibility', 'visible');
      }
    });

    // When a key is pressed, a running timeout for filtering gets stopped
    $('#schedules #course_filter').keydown(function() {
      clearTimeout(course_filter_timer);
      $('#schedules .spinner').css('visibility', 'hidden');
    });

    $('#schedules #course_filter_clear').click(function() {
      $(this).css('visibility', 'hidden');
      $('#schedules #course_filter').val('');
      course_filter_action();
    });
  });
